#!/usr/bin/make -f

#export DH_VERBOSE=1

UPSTREAM_VERSION=$(shell dpkg-parsechangelog \
	| grep ^Version: | cut -d ' ' -f 2 | cut -d '-' -f 1 | cut -d '~' -f 1)

PYVERS=$(shell pyversions -vr)

clean:
	dh_testdir
	dh_testroot
	rm -rf build Pygments.egg-info
	find . -name "*\.py[co]" -exec rm {} \;
	dh_clean

build:

install: build $(PYVERS:%=install-python%)
install-python%:
	python$* setup.py install --single-version-externally-managed \
		--root debian/python-pygments
	mv debian/python-pygments/usr/lib/python$*/site-packages/Pygments-${UPSTREAM_VERSION}-py$*.egg-info \
	   debian/python-pygments/usr/lib/python$*/site-packages/Pygments-${UPSTREAM_VERSION}.egg-info
	sed -i -e '1 s/python.*/python/' debian/python-pygments/usr/bin/pygmentize

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs -i
	dh_installdocs -i
	dh_pycentral -i
	dh_compress -i -X.py
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary-arch:

binary: binary-indep binary-arch

tarball:
	@REV=`LC_ALL=C svn --non-interactive info http://trac.pocoo.org/repos/pygments/trunk \
		| grep Revision | cut -c 11-`; \
	if [ "$$REV" = "" ]; then exit 1; fi; \
	svn -q export http://trac.pocoo.org/repos/pygments/trunk pygments-svn$${REV}; \
	VERSION=`grep "__version__ = " pygments-svn$${REV}/pygments/__init__.py | cut -d "'" -f 2`; \
	tar -zcf ../pygments_$$VERSION~svn$${REV}.orig.tar.gz pygments-svn$${REV}; \
	rm -rf pygments-svn$${REV}; \
	echo file ../pygments_$$VERSION~svn$${REV}.orig.tar.gz successfully created

.PHONY: build clean binary-indep binary-arch binary install configure
